<div class="activity margin-t-2">
  <div class="padding-l-2 padding-r-2 input-msg">
    <div class="margin-0 activity-getpwd clear">
      <!-- <label for="username">  </label> -->
      <p>请输入您的手机号，并发送验证码</p>
      <form  name="getPwdMobileForm">
        <input id="usermobile" name="usermobile" required="required" type="tel" ng-model="user.mobile" placeholder="请输入手机号" ng-pattern="/^((13[0-9])|(15[^4,\D])|(18[0-9])|(17[0678])|(14[0-9]))\d{8}$/" ensure-mobile-exist autofocus>
        <br>
        <p class="ft-red" ng-if="getPwdMobileForm.usermobile.$dirty && getPwdMobileForm.usermobile.$invalid">
          <small ng-if="getPwdMobileForm.usermobile.$error.unique">账户不存在</small>
          <small ng-if="getPwdMobileForm.usermobile.$error.pattern">手机号码格式不正确</small>
          <small ng-if="getCaptchaErr">{{getCaptchaErr}}</small>
        </p>

        <p class="fl width-full">
          <input type="number" placeholder="请输入验证码" class="border-grey border-ra-left" ng-model="user.captcha">
          <button class="button-getpwd border-ra-right {{getPwdMobileForm.usermobile.$invalid ? 'button-disabled border-ra-0 ft-orange' : 'border-ra-0 border-none'}}"  onclick="countDown(this,60,'out');" ng-click="getPwdMobileForm.usermobile.$error.unique || sendMobileCaptcha(user);" ng-disabled="getPwdMobileForm.usermobile.$invalid">获取验证码
          </button>
        </p>
        <p class="ft-red" ng-if="getCaptchaErr">
          <small>{{getCaptchaErr}}</small>
        </p>
        <button class="width-full margin-t-2 button button-primary button-shadow" ng-click="newPwd(user.mobile,user.captcha)" my-click-once>下一步</button>
      </form>
    </div>
  </div>
</div>
<script>
function countDown(obj, second, inOrOut) {
  var getMobile = document.getElementById("usermobile");
  var mobilePattern = /^((13[0-9])|(15[^4,\D])|(18[0-9])|(17[0678])|(14[0-9]))\d{8}$/;

  if (inOrOut === 'out' && window.buttonFlag == 0) {
    return;
  }

  // 如果秒数还是大于0，则表示倒计时还没结束
  if (mobilePattern.test(getMobile.value)) {
    if (second >= 0) {
      // 获取默认按钮上的文字

      if (typeof buttonDefaultValue === 'undefined') {
        buttonDefaultValue = obj.defaultValue;
      }
      // 按钮置为不可点击状态
      obj.disabled = true;
      window.buttonFlag = 0;
      // 按钮里的内容呈现倒计时状态
      //obj.value = buttonDefaultValue + '(' + second + ')';
      obj.innerHTML = "重新发送" + "(" + second + ")";
      obj.className = 'button-getpwd white-button border-none border-ra-0 ft-grey7 padding-0 u-pull-right text-center';
      // 时间减一
      second--;
      // 一秒后重复执行
      setTimeout(function() {
        countDown(obj, second, 'in');
      }, 1000);
      // 否则，按钮重置为初始状态
    } else {
      // 按钮置为可点击状态
      obj.disabled = false;
      window.buttonFlag = 1;
      // 按钮里的内容恢复初始状态
      obj.className = 'button-getpwd padding-0 u-pull-right border-none border-ra-0 text-center';
      obj.innerHTML = "发送验证码";
    }
  } else {
    obj.disabled = true;
    window.buttonFlag = 0;
  }
}
</script>
